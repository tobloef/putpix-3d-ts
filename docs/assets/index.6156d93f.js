const it=function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}};it();const U=[255,255,255],ct=[255,0,0],at=[0,255,0],lt=[0,0,255];function ut(t,o,n){return t*(1-n)+o*n}function F(t,o,n){return t.map((e,r)=>{const s=o[r];return ut(e,s,n)})}function z(t,o,n){return Math.abs(t[0]*(o[1]-n[1])+o[0]*(n[1]-t[1])+n[0]*(t[1]-o[1]))/2}function y(t,o){return t.map((n,e)=>n+o[e])}function k(t,o){return t.map((n,e)=>n-o[e])}function L(t,o){return t.map(n=>n*o)}function Q(t,o){return t.map((n,e)=>n*o[e])}function ft(t,o){return t.map(n=>n/o)}function pt(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2))}function $(t){const o=pt(t);if(o===0)throw new Error("Cannot normalize vector with magnitude of 0.");return t.map(n=>n/o)}function x(t,o){return t.reduce((n,e,r)=>n+e*o[r],0)}function dt(t,o){return[t[1]*o[2]-t[2]*o[1],t[2]*o[0]-t[0]*o[2],t[0]*o[1]-t[1]*o[0]]}function _(t,o){if(t[0].length!==o.length)throw new Error("Invalid matrix multiplication.");return t.map((n,e)=>o[0].map((r,s)=>n.reduce((i,c,l)=>i+t[e][l]*o[l][s],0)))}function I(t,o){return _(t,o.map(n=>[n]))}function ht(t){return t.map((o,n)=>o.map((e,r)=>t[r][n]))}function T(t){const o=X(t[0]),n=[[1,0,0],[0,Math.cos(o),-Math.sin(o)],[0,Math.sin(o),Math.cos(o)]],e=X(t[1]),r=[[Math.cos(e),0,Math.sin(e)],[0,1,0],[-Math.sin(e),0,Math.cos(e)]],s=X(t[2]),i=[[Math.cos(s),-Math.sin(s),0],[Math.sin(s),Math.cos(s),0],[0,0,1]];return _(_(r,n),i)}function X(t){return t*(Math.PI/180)}function mt(t,o,n,e){const r=z(o,n,e),s=z(t,n,e),i=z(o,t,e),c=z(o,n,t);if(r===0)return[!1,[0,0,0]];const l=1e-6,a=Math.abs(r-(s+i+c))<=l,u=s/r,f=i/r,p=c/r;return[a,[u,f,p]]}function wt(t,o,n,e){return[E(t[0],o[0],n[0],e),E(t[1],o[1],n[1],e),E(t[2],o[2],n[2],e)]}function E(t,o,n,e){const r=Math.min(e[0],.99999),s=Math.min(e[1],.99999),i=Math.min(e[2],.99999);return(r*t+s*o+i*n)/(r+s+i)}function P(t,o,n){return Math.max(Math.min(t,n),o)}function yt(t,o,n){return t.map(e=>P(e,o,n))}function gt(t){const o=y(t[1],L(t[0],-1)),n=y(t[2],L(t[0],-1)),e=dt(o,n);return e.every(r=>r===0)?null:$(e)}function vt(t,o){return Math.sqrt(Mt(t,o))}function Mt(t,o){return Math.pow(o[0]-t[0],2)+Math.pow(o[1]-t[1],2)+Math.pow(o[2]-t[2],2)}function bt(t,o,n,e){window.addEventListener("keydown",r=>{if(r.key==="ArrowUp"){r.preventDefault();const s=T(t.rotation),i=I(s,[0,0,n]).map(c=>c[0]);t.translation=y(t.translation,i)}if(r.key==="ArrowDown"){r.preventDefault();const s=T(t.rotation),i=I(s,[0,0,n]).map(c=>c[0]);t.translation=k(t.translation,i)}if(r.key==="ArrowLeft"){r.preventDefault();const s=T(t.rotation),i=I(s,[n,0,0]).map(c=>c[0]);t.translation=k(t.translation,i)}if(r.key==="ArrowRight"){r.preventDefault();const s=T(t.rotation),i=I(s,[n,0,0]).map(c=>c[0]);t.translation=y(t.translation,i)}r.key==="w"&&(r.preventDefault(),t.rotation[0]-=e),r.key==="s"&&(r.preventDefault(),t.rotation[0]+=e),r.key==="a"&&(r.preventDefault(),t.rotation[1]-=e),r.key==="d"&&(r.preventDefault(),t.rotation[1]+=e),r.key==="e"&&(r.preventDefault(),t.rotation[2]+=e),r.key==="q"&&(r.preventDefault(),t.rotation[2]-=e),r.key==="i"&&(r.preventDefault(),o.objects[0].transform.rotation[0]+=e),r.key==="j"&&(r.preventDefault(),o.objects[0].transform.rotation[1]+=e),r.key==="k"&&(r.preventDefault(),o.objects[0].transform.rotation[0]-=e),r.key==="l"&&(r.preventDefault(),o.objects[0].transform.rotation[1]-=e),r.key==="c"&&(r.preventDefault(),o.lights[0].color[0]-=10),r.key==="v"&&(r.preventDefault(),o.lights[0].color[1]-=10),r.key==="b"&&(r.preventDefault(),o.lights[0].color[2]-=10),r.key==="f"&&(r.preventDefault(),o.lights[0].color[0]+=10),r.key==="g"&&(r.preventDefault(),o.lights[0].color[1]+=10),r.key==="h"&&(r.preventDefault(),o.lights[0].color[2]+=10)})}function Vt(t,o,n,e){if(o<0||n<0||o>t.width-1||n>t.height-1)return;o=Math.round(o),n=Math.round(n);const r=o*4+(t.height-1-n)*t.width*4;t.data[r+0]=e[0],t.data[r+1]=e[1],t.data[r+2]=e[2],t.data[r+3]=255}function It(t,o,n,e,r,s,i,c){let[l,a]=Tt([n,e,r]);l=[P(l[0],0,t.width),P(l[1],0,t.height)],a=[P(a[0],0,t.width),P(a[1],0,t.height)];for(let u=l[1];u<=a[1];u++)for(let f=l[0];f<=a[0];f++){const[p,d]=mt([f,u],n,e,r);if(p){const g=wt(s.color,i.color,c.color,d),v=E(s.z,i.z,c.z,d),M=1/v,b=f+u*t.width;M>o[b]&&(Vt(t,f,u,g),f>=0&&u>=0&&f<t.width&&u<t.height&&(o[b]=M))}}}function Tt(t){if(t.length===0)return[[0,0],[0,0]];let o=[1/0,1/0],n=[-1/0,-1/0];for(const e of t)e[0]<o[0]&&(o[0]=e[0]),e[1]<o[1]&&(o[1]=e[1]),e[0]>n[0]&&(n[0]=e[0]),e[1]>n[1]&&(n[1]=e[1]);return[[Math.floor(o[0]),Math.floor(o[1])],[Math.ceil(n[0]),Math.ceil(n[1])]]}function kt(t,o){const n=t.width/t.height,e=1,r=1,s=o[1]*r/o[2],c=o[0]*r/o[2]*t.width/n+t.width/2,l=s*t.height/e+t.height/2;return[c,l]}const V={distance:-.01,normal:[0,0,1]};function Pt(t){const o=[];return t.forEach(n=>{const e=n.verts.map(i=>x(V.normal,i)+V.distance);let r=[],s=[];if(e.forEach((i,c)=>{i<=0?s.push(c):r.push(c)}),s.length===0)o.push(n);else if(s.length===1){const[i,c]=r,[l]=s,a=n.verts[i],u=n.verts[c],f=n.verts[l],p=n.colors[i],d=n.colors[c],g=n.colors[l],{point:v,proportion:M}=D(V,[a,f]),{point:b,proportion:Z}=D(V,[u,f]),C=F(p,g,M),O=F(d,g,Z);let h=[];h[i]=a,h[c]=u,h[l]=v;let m=[];m[i]=p,m[c]=d,m[l]=C;let N=[];N[i]=v,N[c]=u,N[l]=b;let A=[];A[i]=C,A[c]=d,A[l]=O,o.push({verts:h,colors:m}),o.push({verts:N,colors:A});return}else if(s.length===2){const[i]=r,[c,l]=s,a=n.verts[i],u=n.verts[c],f=n.verts[l],p=n.colors[i],d=n.colors[c],g=n.colors[l],{point:v,proportion:M}=D(V,[a,u]),{point:b,proportion:Z}=D(V,[a,f]),C=F(p,d,M),O=F(p,g,Z);let h=[];h[i]=a,h[c]=v,h[l]=b;let m=[];m[i]=p,m[c]=C,m[l]=O,o.push({verts:h,colors:m});return}else if(s.length===3)return}),o}function D(t,o){const n=(-t.distance-x(t.normal,o[0]))/x(t.normal,k(o[1],o[0]));return{point:y(o[0],L(k(o[1],o[0]),n)),proportion:n}}function jt(t,o){const n=Q(t,o.scale),e=T(o.rotation),r=I(e,n).map(i=>i[0]);return y(r,o.translation)}function xt(t,o){const n=S(t,o);return W(t,n)}function S(t,o){return k(o,t.translation)}function W(t,o){const n=T(t.rotation),e=ht(n);return I(e,o).map(s=>s[0])}function Y(t,o){return t=Math.ceil(t),o=Math.floor(o+1),Math.floor(Math.random()*(o-t)+t)}function G(t){const o=t.split(/\r?\n/),n=o.filter(s=>s.startsWith("v ")).map(s=>s.slice(2)).map(s=>s.split(" ")).map(s=>s.map(Number));return{tris:o.filter(s=>s.startsWith("f ")).map(s=>s.trim()).map(s=>s.split(" ").slice(1)).map(s=>s.map(i=>i.split("/")[0])).map(s=>s.map(Number)).map(s=>s.map(i=>i-1)).map(s=>s.map(i=>{const c=n[i];if(c==null)throw new Error(`Failed to map vertex index to vert (vert index: ${i}).`);return c})).map(s=>{const i=s.length-2,c=[];if(i<1)return[];for(let l=0;l<i;l++)c.push([s[0],s[1+l],s[2+l]]);return c}).flat().map(s=>{const i=[Y(255,255),Y(255,255),Y(255,255)];return{verts:s,colors:[i,i,i]}})}}async function H(t){const o=await fetch(t);if(!o.ok)throw new Error(`Failed to load file "${t}".`);return await o.text()}function Ct(t,o,n){let e=[0,0,0];for(const s of n){let i=0;if(s.type==="ambient")i=s.intensity;else if(s.type==="directional"){const l=Math.max(0,-x(s.direction,o));i=s.intensity*l}else if(s.type==="point"){const l=vt(s.position,t),a=1/Math.pow(l,2),u=s.intensity*a,f=$(k(t,s.position)),p=Math.max(0,-x(f,o));i=u*p}const c=L(s.color,i);e=y(e,c)}return ft(e,255)}const w=document.querySelector("canvas"),K=w.getContext("2d"),tt=K.canvas.getBoundingClientRect();var J;const q=(J=window.devicePixelRatio)!=null?J:1,ot=1/2;w.width=Math.round(tt.width*q*ot);w.height=Math.round(tt.height*q*ot);K.scale(q,q);performance.now();const Nt=new ImageData(w.width,w.height),B=new ImageData(w.width,w.height),nt=new Float64Array(w.width*w.height),rt=Float64Array.from(nt);let et;async function At(){for(const t of j.objects)t.model!=null||t.modelPath==null||(t.model=G(await H(t.modelPath)));et=G(await H("./models/cube.obj")),st()}function st(){B.data.set(Nt.data),rt.set(nt),performance.now(),Rt(),K.putImageData(B,0,0),requestAnimationFrame(st)}const Ft=.2,zt=5,Dt=[{type:"ambient",intensity:.1,color:U},{type:"directional",intensity:0,direction:$([0,0,1]),color:U},{type:"point",intensity:20,position:[0,1,5],color:ct},{type:"point",intensity:20,position:[-4.33,1,-2.5],color:at},{type:"point",intensity:20,position:[4.33,1,-2.5],color:lt}],Et=[{transform:{translation:[0,0,0],scale:[1,1,1],rotation:[0,-120,0]},modelPath:"./models/rat.obj"}],j={lights:Dt,objects:Et};let R={translation:[0,4,-10],rotation:[20,0,0],scale:[1,1,1]};function Rt(t){let o=[...j.objects];j.lights.forEach(e=>{e.type==="point"&&(e.position=W({rotation:[0,2,0],scale:[1,1,1],translation:[0,0,0]},e.position),o.push({model:{tris:et.tris.map(r=>({...r,colors:[e.color,e.color,e.color]}))},transform:{translation:e.position,scale:[.03,.03,.03],rotation:[0,0,0]}}))});const n=j.lights.map(e=>{switch(e.type){case"ambient":return e;case"directional":const r=W(R,e.direction);return{...e,direction:r};case"point":const s=S(R,e.position);return{...e,position:s}}});o.forEach(e=>{if(e.model==null)return;const s=e.model.tris.map(a=>({...a,verts:a.verts.map(u=>{const f=jt(u,e.transform);return xt(R,f)})})),i=Pt(s);if(i===null)return;i.map(a=>{{const u=gt(a.verts);if(u===null)return a;const f=a.verts.map(p=>Ct(p,u,n));return{...a,colors:a.colors.map((p,d)=>yt(Q(p,f[d]),0,255))}}}).map(a=>({color:a.colors,unprojectedVerts:a.verts,projectedVerts:a.verts.map(u=>kt(B,u))})).forEach(a=>{It(B,rt,a.projectedVerts[0],a.projectedVerts[1],a.projectedVerts[2],{z:a.unprojectedVerts[0][2],color:a.color[0]},{z:a.unprojectedVerts[1][2],color:a.color[1]},{z:a.unprojectedVerts[2][2],color:a.color[2]})})})}bt(R,j,Ft,zt);At();
