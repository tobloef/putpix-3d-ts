const C=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerpolicy&&(o.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?o.credentials="include":r.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=e(r);fetch(r.href,o)}};C();function w(t,n,e){return Math.abs(t[0]*(n[1]-e[1])+n[0]*(e[1]-t[1])+e[0]*(t[1]-n[1]))/2}function g(t,n){return t.map((e,i)=>e+n[i])}function x(t,n){return t.map((e,i)=>e-n[i])}function _(t,n){return t.map(e=>e*n)}function D(t,n){return t.map((e,i)=>e*n[i])}function W(t,n){return t.reduce((e,i,r)=>e+i*n[r],0)}function P(t,n){if(t[0].length!==n.length)throw new Error("Invalid matrix multiplication.");return t.map((e,i)=>n[0].map((r,o)=>e.reduce((a,s,c)=>a+t[i][c]*n[c][o],0)))}function p(t,n){return P(t,n.map(e=>[e]))}function $(t){return t.map((n,e)=>n.map((i,r)=>t[r][e]))}function h(t){const n=b(t[0]),e=[[1,0,0],[0,Math.cos(n),-Math.sin(n)],[0,Math.sin(n),Math.cos(n)]],i=b(t[1]),r=[[Math.cos(i),0,Math.sin(i)],[0,1,0],[-Math.sin(i),0,Math.cos(i)]],o=b(t[2]),a=[[Math.cos(o),-Math.sin(o),0],[Math.sin(o),Math.cos(o),0],[0,0,1]];return P(P(r,e),a)}function b(t){return t*(Math.PI/180)}function K(t,n,e,i){const r=w(n,e,i),o=w(t,e,i),a=w(n,t,i),s=w(n,e,t);if(r===0)return[!1,[0,0,0]];const c=1e-6,d=Math.abs(r-(o+a+s))<=c,l=o/r,f=a/r,I=s/r;return[d,[l,f,I]]}function U(t,n,e,i){return[y(t[0],n[0],e[0],i),y(t[1],n[1],e[1],i),y(t[2],n[2],e[2],i)]}function y(t,n,e,i){const r=Math.min(i[0],.99999),o=Math.min(i[1],.99999),a=Math.min(i[2],.99999);return(r*t+o*n+a*e)/(r+o+a)}function M(t,n,e){return Math.max(Math.min(t,e),n)}function G(t,n,e,i){window.addEventListener("keydown",r=>{if(r.key==="ArrowUp"){r.preventDefault();const o=h(t.rotation),a=p(o,[0,0,e]).map(s=>s[0]);t.translation=g(t.translation,a)}if(r.key==="ArrowDown"){r.preventDefault();const o=h(t.rotation),a=p(o,[0,0,e]).map(s=>s[0]);t.translation=x(t.translation,a)}if(r.key==="ArrowLeft"){r.preventDefault();const o=h(t.rotation),a=p(o,[e,0,0]).map(s=>s[0]);t.translation=x(t.translation,a)}if(r.key==="ArrowRight"){r.preventDefault();const o=h(t.rotation),a=p(o,[e,0,0]).map(s=>s[0]);t.translation=g(t.translation,a)}r.key==="w"&&(r.preventDefault(),t.rotation[0]-=i),r.key==="s"&&(r.preventDefault(),t.rotation[0]+=i),r.key==="a"&&(r.preventDefault(),t.rotation[1]-=i),r.key==="d"&&(r.preventDefault(),t.rotation[1]+=i),r.key==="e"&&(r.preventDefault(),t.rotation[2]+=i),r.key==="q"&&(r.preventDefault(),t.rotation[2]-=i),r.key==="i"&&(r.preventDefault(),n[0].transform.rotation[0]+=i),r.key==="j"&&(r.preventDefault(),n[0].transform.rotation[1]+=i),r.key==="k"&&(r.preventDefault(),n[0].transform.rotation[0]-=i),r.key==="l"&&(r.preventDefault(),n[0].transform.rotation[1]-=i)})}function H(t,n,e,i){if(n<0||e<0||n>t.width-1||e>t.height-1)return;n=Math.round(n),e=Math.round(e);const r=n*4+(t.height-1-e)*t.width*4;t.data[r+0]=i[0],t.data[r+1]=i[1],t.data[r+2]=i[2],t.data[r+3]=255}function J(t,n,e,i,r,o,a,s){let[c,d]=Q([e,i,r]);c=[M(c[0],0,t.width),M(c[1],0,t.height)],d=[M(d[0],0,t.width),M(d[1],0,t.height)];for(let l=c[1];l<=d[1];l++)for(let f=c[0];f<=d[0];f++){const[I,F]=K([f,l],e,i,r);if(I){const q=U(o.color,a.color,s.color,F),B=y(o.z,a.z,s.z,F),V=1/B,z=f+l*t.width;V>n[z]&&(H(t,f,l,q),f>=0&&l>=0&&f<t.width&&l<t.height&&(n[z]=V))}}}function Q(t){if(t.length===0)return[[0,0],[0,0]];let n=[1/0,1/0],e=[-1/0,-1/0];for(const i of t)i[0]<n[0]&&(n[0]=i[0]),i[1]<n[1]&&(n[1]=i[1]),i[0]>e[0]&&(e[0]=i[0]),i[1]>e[1]&&(e[1]=i[1]);return[[Math.floor(n[0]),Math.floor(n[1])],[Math.ceil(e[0]),Math.ceil(e[1])]]}function S(t,n){const e=t.width/t.height,i=1,r=1,o=n[1]*r/n[2],s=n[0]*r/n[2]*t.width/e+t.width/2,c=o*t.height/i+t.height/2;return[s,c]}const E={distance:-.1,normal:[0,0,1]};function tt(t){const n=[];return t.forEach(e=>{const i=e.verts.map(o=>W(E.normal,o)+E.distance);let r=[];if(i.forEach((o,a)=>{o<=0&&r.push(a)}),r.length===0)n.push(e);else{if(r.length===1)return;if(r.length===2)return;if(r.length===3)return}}),n}function nt(t,n){const e=D(t,n.scale),i=h(n.rotation),r=p(i,e).map(a=>a[0]);return g(r,n.translation)}function rt(t,n){const e=x(n,t.translation),i=h(t.rotation),r=$(i);return p(r,e).map(a=>a[0])}function k(t,n){return t=Math.ceil(t),n=Math.floor(n+1),Math.floor(Math.random()*(n-t)+t)}function ot(t){const n=t.split(/\r?\n/),e=n.filter(o=>o.startsWith("v ")).map(o=>o.slice(2)).map(o=>o.split(" ")).map(o=>o.map(Number));return{tris:n.filter(o=>o.startsWith("f ")).map(o=>o.trim()).map(o=>o.split(" ").slice(1)).map(o=>o.map(a=>a.split("/")[0])).map(o=>o.map(Number)).map(o=>o.map(a=>a-1)).map(o=>o.map(a=>{const s=e[a];if(s==null)throw new Error(`Failed to map vertex index to vert (vert index: ${a}).`);return s})).map(o=>{const a=o.length-2,s=[];if(a<1)return[];for(let c=0;c<a;c++)s.push([o[0],o[1+c],o[2+c]]);return s}).flat().map(o=>{const a=[k(0,255),k(0,255),k(0,255)];return{verts:o,color:[a,a,a]}})}}async function et(t){const n=await fetch(t);if(!n.ok)throw new Error(`Failed to load file "${t}".`);return await n.text()}const u=document.querySelector("canvas"),j=u.getContext("2d"),N=j.canvas.getBoundingClientRect();var L;const v=(L=window.devicePixelRatio)!=null?L:1,Z=1/2;u.width=Math.round(N.width*v*Z);u.height=Math.round(N.height*v*Z);j.scale(v,v);let R=performance.now();const it=new ImageData(u.width,u.height),T=new ImageData(u.width,u.height),A=new Float64Array(u.width*u.height),O=Float64Array.from(A);async function at(){m[0].model=ot(await et("./models/rat.obj")),X()}function X(){T.data.set(it.data),O.set(A);const t=performance.now(),n=(t-R)/1e3;lt(n),j.putImageData(T,0,0),R=t,requestAnimationFrame(X)}const st=.5,ct=5,m=[{transform:{translation:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},model:null}];let Y={translation:[-12,2,0],rotation:[10,90,0],scale:[1,1,1]};function lt(t){m[0].transform.rotation=g(m[0].transform.rotation,_([0,t,0],100)),m.forEach(n=>{if(n.model===null)return;const i=n.model.tris.map(a=>({...a,verts:a.verts.map(s=>{const c=nt(s,n.transform);return rt(Y,c)})})),r=tt(i);if(r===null)return;r.map(a=>({color:a.color,unprojectedVerts:a.verts,projectedVerts:a.verts.map(s=>S(T,s))})).forEach(a=>{J(T,O,a.projectedVerts[0],a.projectedVerts[1],a.projectedVerts[2],{z:a.unprojectedVerts[0][2],color:a.color[0]},{z:a.unprojectedVerts[1][2],color:a.color[1]},{z:a.unprojectedVerts[2][2],color:a.color[2]})})})}G(Y,m,st,ct);at();
